#!/usr/bin/env sh
set -u  # Treat unset variables as an error.
start_time=$(date +%s)

SCRIPT_NAME="$(basename "$0")"
export SCRIPT_NAME

SCRIPT_DIR="$(dirname "$0")"
MODULES_DIR="${SCRIPT_DIR}/sh-modules"
LIB_DIR="${SCRIPT_DIR}/php-dev-helper-lib"
WORK_DIR="${PWD}"

# shellcheck disable=SC1090
. "${MODULES_DIR}/core.sh"
# shellcheck disable=SC1090
. "${MODULES_DIR}/github.sh"
# shellcheck disable=SC1090
. "${LIB_DIR}/version.sh"
# shellcheck disable=SC1090
. "${LIB_DIR}/options.sh"
# shellcheck disable=SC1090
. "${LIB_DIR}/helpers.sh"
# shellcheck disable=SC1090
. "${LIB_DIR}/settings.sh"
# shellcheck disable=SC1090
. "${LIB_DIR}/commands.sh"
# shellcheck disable=SC1090
. "${LIB_DIR}/updater.sh"

SCRIPT_DIR="$(core_get_realpath "${SCRIPT_DIR}")"
LIB_DIR="$(core_get_realpath "${LIB_DIR}")"
WORK_DIR="$(core_get_realpath "${WORK_DIR}")"
VERSION_FILE="$(core_get_realpath "${VERSION_FILE}")"
BUILD_FILE="$(core_get_realpath "${BUILD_FILE}")"

console_debug "Script name: ${SCRIPT_NAME}"
console_debug "Script dir: ${SCRIPT_DIR}"
console_debug "Lib dir: ${LIB_DIR}"
console_debug "Work dir: ${WORK_DIR}"
console_debug "VERSION file: ${VERSION_FILE}"
console_debug "BUILD file: ${BUILD_FILE}"

__hash="$(version_save_build_hash)"
if [ $? -eq "${PTS_TRUE}" ]
then
    console_debug "Saved hash: '${__hash}'"
else
    console_debug "Hash not saved"
fi

_read_options "$@"

### Print header
console_log_header "PHP Dev Helper Script"
console_info "Version $(_version)"
console_debug "Version $(_version "${PTS_TRUE}")"

### Run checks
console_debug "Working directory: ${WORK_DIR}"

helper_check_working_env

_show_options
_pts_helper_check_container


### Start
__TITLE="$(core_get_title_from_file "${WORK_DIR}/TERMINAL_TITLE" "${WORK_DIR}")"
__title="${__TITLE} - Testing..."
console_debug "Setting title '${__title}'"
core_set_terminal_title "${__title}"

if [ "${PTS_EXECUTE}" -eq "${PTS_TRUE}" ]; then
    console_debug "Executing..."
    if [ "${PTS_CONTAINER_STARTED}" -eq "${PTS_TRUE}" ]; then
        _phpunit_exec
        _php_metrics_exec
        _multi_tester_exec
        _phpstan_exec
        _psalm_exec
        _php_cs_exec
        _php_cs_bf_exec
    else
        console_error "Container is not started"
    fi
fi

### Finish
if [ "${PTS_DEBUG}" -eq 0 ]; then
    console_dark "$(date '+%Y-%m-%d %H:%M:%S')"
fi
console_dark "Executed in $(($(date +%s)-start_time))s"
console_dark "Bye!"

__title="${__TITLE}"
console_debug "Setting title '${__title}'"
core_set_terminal_title "${__title}"

### Debug code
# console_debug "Debug messages:"
# console_debug "SCRIPT_NAME: ${SCRIPT_NAME}"
# console_debug "SCRIPT_DIR: ${SCRIPT_DIR}"
# console_debug "WORK_DIR: ${WORK_DIR}"

# console_dark "dark"
# console_info "info"
# console_log_comment "comment"
# console_log_notice "notice"

# console_warning "Warn message"
# console_error "Error message"
# console_fatal "Fatal message"