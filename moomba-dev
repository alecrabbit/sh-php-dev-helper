#!/usr/bin/env sh

############################
### Common section Begin ###
############################

__lib="php-dev-helper-lib"
__modules="sh-modules"

set -u  # Treat unset variables as an error.

SCRIPT_DIR="$(dirname "$0")"
LIB_DIR="${SCRIPT_DIR}/${__lib}"
MODULES_DIR="${LIB_DIR}/${__modules}"
WORK_DIR="${PWD}"

### LOAD MODULES
# shellcheck disable=SC1090
. "${MODULES_DIR}/include_core.sh"  # Core modules loader
# shellcheck disable=SC1090
. "${LIB_DIR}/include_common.sh"    # Common modules loader

SCRIPT_VERSION="$(version_load_version "${VERSION_FILE}")"
SCRIPT_BUILD="$(version_load_build "${BUILD_FILE}")"

export SCRIPT_VERSION
export SCRIPT_BUILD

__TITLE="$(core_get_title_from_file "${WORK_DIR}/TERMINAL_TITLE" "${WORK_DIR}")"

############################
###  Common section End  ###
############################

### Moomba modules loader
# shellcheck disable=SC1090
. "${LIB_DIR}/include_mmb.sh"      

mmb_load_settings
mmb_read_options "$@"

func_print_header "PHP Package creator"

mmb_show_settings
mmb_check_working_env

### Creating new package
if [ "${COMMON_EXECUTE:-${CR_TRUE}}" -eq "${CR_TRUE}" ]; then
    console_warning "Under development - use with caution!"
    mmb_working_dir
    mmb_check_default_template
    core_set_terminal_title "${__TITLE} - Creating..."
    console_debug "Executing..."
    console_dark "Creating new package"
    mmb_show_package_values
    if core_ask_question "Create package '${TMPL_PACKAGE_DIR}'?"; then
        mmb_check_package_dir "${TMPL_PACKAGE_DIR}"
        mmb_create_package "${TMPL_USE_TEMPLATE_NAME}" "${TMPL_PACKAGE_DIR}"
        mmb_package_created "${TMPL_PACKAGE_DIR}"
        export FLAG_DONE="${CR_TRUE}"
    else
        export FLAG_CANCELED="${CR_TRUE}"
    fi
    mmb_cleanup
else
    console_debug "No execution selected"
fi

func_print_footer
